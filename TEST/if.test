#!/bin/bash -xv

tmp=/tmp/$$
scr=$(basename $0)

ERROR_CHECK(){
	[ "$(tr -d '0 ' <<< ${PIPESTATUS[@]} )" = "" ] && return
	rm -f $tmp-*
	echo "$scr" "$1"
	exit 1
}

os=linux
[ "$(uname)" != "Linux" ] && os=mac

#########################################
# TEST1: error cancel
#########################################
cat << FIN > $tmp-in
a
b
c
FIN

cat << FIN > $tmp-out
a
b
c
FIN

cat << FIN > $tmp-linux
? /bin/false
FIN

cat << FIN > $tmp-mac
? /usr/bin/false
FIN

../glue $tmp-$os
ERROR_CHECK "TEST1 error"

#########################################
# TEST2: error cancel (pipeline)
#########################################

cat << FIN > $tmp-out
hoge
FIN

cat << FIN > $tmp-linux
? /bin/false >>= /bin/echo 'hoge'
FIN

cat << FIN > $tmp-mac
? /usr/bin/false >>= /bin/echo 'hoge'
FIN

../glue $tmp-$os > $tmp-ans
ERROR_CHECK "TEST2.1 error"

diff $tmp-out $tmp-ans
ERROR_CHECK "TEST2.2 error"

#########################################
# TEST3: if then else
#########################################

cat << FIN > $tmp-out
OK
a
OK
OK
FIN

cat << FIN > $tmp-linux
? /bin/true
	/bin/echo 'OK'
| /bin/echo 'a'
	/bin/echo 'no'
| otherwise
	/bin/echo 'ow'

? /bin/false
	/bin/echo 'NG'
| /bin/echo 'a'
	/bin/echo 'OK'

? /bin/false
	/bin/echo 'NG'
| otherwise
	/bin/echo 'OK'
FIN

cat << FIN > $tmp-mac
? /usr/bin/true
	/bin/echo 'OK'
| /bin/echo 'a'
	/bin/echo 'no'
| otherwise
	/bin/echo 'ow'

? /usr/bin/false
	/bin/echo 'NG'
| /bin/echo 'a'
	/bin/echo 'OK'

? /usr/bin/false
	/bin/echo 'NG'
| otherwise
	/bin/echo 'OK'
FIN

../glue $tmp-$os > $tmp-ans
ERROR_CHECK "TEST3.1 error"

diff $tmp-out $tmp-ans
ERROR_CHECK "TEST3.2 error"

rm -f $tmp-*
